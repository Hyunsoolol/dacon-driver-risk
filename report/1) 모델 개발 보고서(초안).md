# 모델 개발 보고서
## 1. 프로젝트 개요 및 문제 접근법
### 1) 모델 설계 전략 및 접근법

- **문제 정의**
  - 운수종사자의 인지검사(A/B형) 결과와 과거 검사 이력을 활용하여  
    향후 **교통사고 위험도(사고 발생 확률)** 를 예측하는 이진 분류 모델 개발.
  - 대회 리더보드 평가는 AUC, Brier score, Expected Calibration Error(ECE)를 조합한 점수로 이루어지며,  
    단순 분류 성능뿐 아니라 **확률의 신뢰도(calibration)** 가 중요함.

- **전체 아키텍처 개요**
  - **전처리·피처엔지니어링 모듈**
    - `1_Preprocess_delta_logratio.py`
    - A/B형 검사 로그를 도메인 기반 요약 피처로 변환
    - PK(운수종사자) 수준 이력·변화(Delta)를 계산하고, 연령/시점 정규화 수행
  - **모델 학습 모듈**
    - `2_Train_Models_v18_delta_logratio.py`
    - CatBoost 기반 **A/B 이원(dual) 모델 구조**
    - K-Fold 교차검증 및 PK별 통계(PK Stats) 생성
    - Isotonic Regression을 통한 확률 보정 및 최종 모델 저장

- **모델 구조 선택 및 이유**
  - **CatBoostClassifier**
    - 범주형 변수(`Age`, `PrimaryKey`)를 직접 처리 가능
    - 결측치·비선형 관계에 강하고, 학습·튜닝이 안정적
    - 트리 기반 모델로 향후 SHAP 등을 통한 **설명 가능성** 확보 용이
  - **A/B 분리 모델**
    - A형과 B형의 과제 구성이 상이하고, 측정하는 인지 기능이 다르므로
      - **모델 A**: A형 전용 – Base + History + Normalization + log_ratio  
      - **모델 B**: B형 전용 – Base + PK Stats + History + Normalization + Delta(B-only) + log_ratio  
    - 각 검사 유형의 특성을 최대한 살리는 구조를 설계.

- **데이터 구조 및 검증 전략**
  - `PrimaryKey` 기준으로 반복 검사가 존재하는 **longitudinal 패널 데이터** 구조.
  - `StratifiedKFold(n_splits=5)`으로 Label 비율을 유지하며 교차검증 수행.
  - Fold별로 학습된 CatBoost + Isotonic 모델을 저장하고, 추론 시 **Fold 평균 앙상블**로 안정적 예측값 산출.

- **데이터 누출 방지 전략**
  - PK 통계(PK Stats)는 각 Fold의 Train 데이터에서만 집계 후  
    같은 Fold의 Train/Validation에만 사용해 데이터 누출을 차단.
  - B형 Delta 피처는 동일 PK의 직전 B 검사와의 차이만 사용하며, A형에서는 명시적으로 제거.

---

### 2) 기술적 차별성

1. **인지심리 도메인에 기반한 피처 설계**
   - A1~A9, B1~B10 과제는 Stroop, Flanker, 주의 전환, 시야각, 다중과제 등  
     인지심리학에서 운전 행동과 연관성이 검증된 과제를 포함.
   - 단순 평균값이 아니라
     - 조건별 반응시간 평균·표준편차
     - 조건별 정답률
     - **Speed–Accuracy Tradeoff** (`rt_mean / acc`)
     - **반응시간 CV** (`rt_std / rt_mean`)
     - **조건 간 log_ratio** (`log(조건1 / 조건2)`)  
     등 인지 기능을 직접 반영하는 지표를 설계.

2. **PK(개인) 수준 이력·변화량 활용**
   - `PrimaryKey` 기준으로 검사를 시간순 정렬하여
     - 누적 검사 횟수, A/B 유형별 누적 검사 횟수
     - 직전 검사 시점 및 검사 간 간격  
     을 계산하고, 이를 **관리 사각지대에 있는 고위험군 탐지**에 활용.
   - B형에서는 직전 B 검사와의 차이(Delta)를 계산해
     - 인지 기능의 **개선/악화 추세**를 모델이 학습하도록 설계.

3. **확률 보정 중심의 위험도 모델**
   - 단순 분류 정확도보다 **실제 사고 확률에 근접한 위험도**를 제공하기 위해
     - CatBoost 출력 확률을 Isotonic Regression으로 보정.
     - AUC, Brier, ECE를 동시에 고려한 Combined Score를 내부 지표로 사용.
   - 의료·안전 분야에서 활용되는 모범 사례를 교통사고 위험 예측에 접목해  
     정책·교육 의사결정에 적합한 예측 확률을 제공.

4. **일반화 구조 및 운영 편의성**
   - 연령·검사 시점은 z-score로 정규화하여  
     특정 시기·집단에 과도하게 특화되지 않도록 일반화 성능을 확보.
   - 전처리·학습·추론이 모두 스크립트화되어 있어  
     데이터만 교체하면 재학습·재배포가 가능한 구조.

---

### 3) 개발 환경 및 도구 구성

| 구분 | 도구/라이브러리               | 버전(예) | 제조사(출처)                  | 용도                                   |
|------|-------------------------------|---------|--------------------------------|----------------------------------------|
| 1    | Python, Jupyter Notebook      | 3.10    | Python Software Foundation     | 전처리, 모델링, 실험 환경             |
| 2    | pandas, numpy, feather-format | 2.x/1.x | Open Source                    | 데이터 로드·가공, 피처 엔지니어링     |
| 3    | CatBoost                      | 1.x     | Yandex                         | Gradient Boosting 기반 이진 분류 모델 |
| 4    | scikit-learn                  | 1.x     | scikit-learn community         | K-Fold, 평가 지표, Isotonic Regression|
| 5    | joblib, tqdm                  | 1.x     | Open Source                    | 모델·통계 저장, 학습 진행률 표시      |

---

## 2. 상세 개발 방법론

### 1) 모델 구조 상세

#### (1) 입력 → 예측 → 후처리 프로세스

- **입력(Data Ingestion)**
  - 메타 데이터: `train.csv`  
    - `PrimaryKey`, `Test`(A/B), `Label`, `Age`, `TestDate` 등
  - 검사 로그: `train/A.csv`, `train/B.csv`  
    - 각 인지과제별 반응시간/정답 여부 시퀀스

- **전처리 및 피처 생성**
  1. `1_Preprocess_delta_logratio.py`
     - `Age`를 숫자형 `Age_num`으로 변환  
     - `TestDate`를 `Year`, `Month`, `YearMonthIndex`로 분해
     - `preprocess_A()`, `preprocess_B()`  
       → 과제별 반응시간 평균·표준편차, 조건별 정답률 등 1차 도메인 피처 생성  
     - `add_features_A()`, `add_features_B()`  
       → Speed–Accuracy, CV, log_ratio, z-score 등 2차 피처 생성  
     - PK 히스토리 및 Delta(B-only) 생성  
       → `pk_hist_*`, `delta_*` 컬럼
     - 결과를 `all_train_data.feather`로 저장, 정규화 통계를 `normalization_stats.pkl`에 저장.

- **모델 학습 및 확률 보정**
  2. `2_Train_Models_v18_delta_logratio.py`
     - `StratifiedKFold(n_splits=5)`으로 Train/Validation 분할
     - 각 Fold의 Train 데이터에서 PK Stats 생성 (`pk_stats_fold`)
     - A/B 데이터 분리 후
       - `train_model_A()` : PK Stats/Delta 없이 CatBoost 학습 + Isotonic 보정  
       - `train_model_B()` : PK Stats + Delta 포함 CatBoost 학습 + Isotonic 보정
     - Fold별 모델(`catboost_A/B_fold*.pkl`)과 보정기(`calibrator_A/B_fold*.pkl`) 저장
     - Fold별 PK Stats를 평균 내어 `pk_stats_final.csv`로 저장

- **추론(서비스) 단계**
  - 신규 데이터에 대해 위와 동일한 전처리 수행  
  - `normalization_stats.pkl`, `pk_stats_final.csv`를 로드하여 동일한 스케일·통계를 적용
  - 검사 유형(A/B)에 따라 해당 Fold 모델 + 보정기를 모두 적용한 후
    - Fold별 예측 확률의 평균을 **최종 위험도**로 사용

#### (2) 핵심 모듈 및 알고리즘 역할

- `preprocess_A/B()`  
  - 시퀀스 형태의 과제 로그를 **인지 기능 요약 지표**로 변환하는 핵심 모듈.
- `add_features_A/B()`  
  - log_ratio, speed–accuracy, CV, z-score 등 **도메인 해석 가능한 2차 피처** 생성.
- `add_delta_features_pk()`  
  - B형 수치 피처에 대해 PK별 직전 값과의 차이를 계산하여 **인지 기능의 변화율**을 표현.
- `train_model_A/B()`  
  - CatBoostClassifier를 이용해 이진 분류 모델을 학습하고,  
    Isotonic Regression으로 확률을 보정하여 **신뢰도 높은 위험도 점수**를 산출.
- `expected_calibration_error()`, `combined_score()`  
  - ECE, Combined Score를 계산하여 **모델의 확률 보정 품질**을 정량 평가.

---

### 2) 외부 지식 활용 및 전략

1. **인지심리학 및 운전 행동 연구 기반 피처 설계**
   - Stroop, Flanker, 주의 전환(Attentional Cueing), 시야각, Hazard Perception 등  
     고위험도 도메인(의료·운전)에서 반복적으로 검증된 과제를 참고.
   - 문헌에서 공통적으로 사용하는 지표
     - 조건 간 반응시간 차이·비율
     - 정확도/오류율
     - Speed–Accuracy Tradeoff
   - 이를 반영해
     - Stroop/Flanker 간섭 효과를 `log(조건1/조건2)` 형태로 정의하고,
     - 조건별 정확도·반응시간 비율을 주요 피처로 채택.

2. **고위험도 예측 모델의 평가 지표**
   - 의료·위험 관리 분야에서는 AUC뿐 아니라 **Brier score, ECE** 등 확률 보정 지표를 함께 사용.
   - 관련 논문을 참고하여
     - CatBoost 출력 확률을 Isotonic Regression으로 보정하고,
     - Reliability curve, ECE 등을 내부 점검 지표로 활용.
   - 이를 통해 “위험도 = 실제 사고 확률에 근접한 숫자”를 목표로 하는 모델을 설계.

3. **인적요인·교통 안전 도메인 지식**
   - 운수종사자의 연령, 근무 연차, 반복 검사 경험은 인지 기능과 사고 위험에 영향을 미칠 수 있다는  
     선행 연구를 참고하여
     - `Age_num`, `Age_num_z`, `pk_hist_*`, `pk_test_*_count` 등 피처로 구현.
   - Hazard Perception 교육이 사고 위험을 감소시킨다는 연구를 참고해  
     향후 **교육·훈련 효과 시뮬레이션**을 위한 구조(Delta, PK Stats)를 설계.

---

### 3) 모델 튜닝 및 최적화 전략

#### (1) 하이퍼파라미터 설정 및 버전별 개선 과정

모델 개발 과정에서 여러 버전을 실험하며 **모델 성능과 ECE를 지속적으로 개선**하였다.

- **v0 (베이스라인)**
  - 단순 수치 요약 + CatBoost 단일 모델
  - PK 이력·Delta·log_ratio 미사용
  - 리더보드 기준, 베이스라인 수준의 점수 확인

- **v1~v17: 도메인 피처 및 히스토리 반영**
  - A/B 검사의 반응시간·정답률을 과제별로 요약하는 1차 피처 추가
  - `pk_hist_total_count`, `pk_hist_A/B_count`, `pk_hist_gap_from_prev` 등 이력 피처 도입
  - **효과**
    - AUC 개선 및 리더보드 점수 상승
    - PK 이력 피처 추가 후, 고위험 PK에 대한 분별력이 향상됨을 내부 분석에서 확인

- **v18: PK Stats 도입 + K-Fold 구조 안정화**
  - Train Fold에서만 집계한 PK 통계(PK Stats)를 B형 모델에 주입
  - 모델 구조를 A/B 이원 구조로 분리
  - **효과**
    - B형에서의 AUC 개선 및 리더보드 점수 추가 향상
    - PK별 평균/편차 정보를 활용해 개인차를 보다 안정적으로 반영

- **v18 + Delta + log_ratio (최종)**
  - 본 보고서에서 사용하는 버전
  - 변경 사항
    - 주요 인지 효과를 *cost*가 아닌 **log_ratio** 기반으로 재정의  
      (예: Stroop/Flanker, 주의 전환의 조건 간 비율)
    - B형 수치 피처에 대해 PK 기준 직전 값과의 차이(Delta) 도입
    - CatBoost 하이퍼파라미터를 A/B에 맞게 분리 튜닝
  - **효과**
    - 내부 Combined Score 기준으로 v18 대비 추가 개선
    - ECE 감소(확률 보정 품질 개선)와 함께 리더보드 Public 점수도 상승

#### (2) 최종 하이퍼파라미터

- **모델 A**
  - `depth = 6`, `learning_rate = 0.05`, `l2_leaf_reg = 3`
- **모델 B**
  - `depth = 3`, `learning_rate = 0.03`, `l2_leaf_reg = 5`
  - `random_strength = 3.0`, `bagging_temperature = 1.0`, `border_count = 128`

#### (3) Combined Score 기반 모델 선택

- 내부 평가 지표:
  - AUC, Brier, ECE를 모두 계산하여
  - `Combined Score = 0.5*(1-AUC) + 0.25*Brier + 0.25*ECE`
- 다양한 피처 조합/하이퍼파라미터를 실험한 후
  - Combined Score와 리더보드 Public 점수를 함께 비교하여  
    **예측력과 확률 신뢰도를 동시에 만족하는 현재 버전**을 최종 모델로 선정.

---

## 3. 모델 구현 상세 설명

### 1) 주요 프로세스 및 실행 흐름

1. **전처리 단계 – `1_Preprocess_delta_logratio.py`**
   - 데이터 로드
     - `train.csv`, `train/A.csv`, `train/B.csv` 읽기
   - 인적·시점 파생
     - `convert_age()`로 `Age` → `Age_num`
     - `split_testdate()`로 `TestDate` → `Year`, `Month`
     - `YearMonthIndex = Year*12 + Month` 계산
   - 인지과제별 1차 피처
     - `preprocess_A(df)`, `preprocess_B(df)`  
       - 반응시간 평균·표준편차(`seq_mean`, `seq_std`)  
       - 조건별 평균·정확도(`masked_operation`, `seq_rate_*`)  
       - 정답 개수, 설문 문항 점수 등
   - 2차 도메인 피처
     - `add_features_A(df)`, `add_features_B(df)`  
       - Speed–Accuracy Tradeoff, CV, log_ratio, z-score
   - PK 히스토리 및 Delta(B-only)
     - 그룹 정렬 후 `pk_hist_*` 생성
     - `add_delta_features_pk(df, test_col_name)`로 B형 수치 피처의 직전 값과 차이 계산
   - 산출물 저장
     - `all_train_data.feather`, `normalization_stats.pkl` 저장

2. **학습 단계 – `2_Train_Models_v18_delta_logratio.py`**
   - 데이터 로드 및 Fold 분할
     - `all_train_data.feather` 로드
     - `StratifiedKFold(5)`으로 인덱스 리스트 생성
   - 공통 유틸
     - `expected_calibration_error()`, `combined_score()`  
       → ECE 및 Combined Score 계산
     - `_build_cb_matrices()`  
       → 수치/범주 피처 분리 및 CatBoost 입력 행렬 구성
   - Fold 루프
     - 각 Fold의 Train 데이터에서 PK Stats 집계 → `pk_stats_fold`
     - A/B 데이터 분할 → `train_model_A()`, `train_model_B()` 호출
     - Isotonic Regression으로 확률 보정 후  
       Fold별 모델 및 보정기 저장
   - 최종 PK Stats
     - Fold별 `pk_stats_fold`를 평균 내어 `pk_stats_final.csv` 저장

### 2) 주요 함수·파일 및 파라미터 설정

- **파일 구조**
  - `1_Preprocess_delta_logratio.py` : 전처리 및 피처엔지니어링
  - `2_Train_Models_v18_delta_logratio.py` : 학습·평가·모델 저장
- **핵심 함수**
  - `preprocess_A/B`, `add_features_A/B`, `add_delta_features_pk`
  - `expected_calibration_error`, `combined_score`
  - `train_model_A`, `train_model_B`
- **중요 파라미터**
  - K-Fold 수: 5  
  - CatBoost iterations: 3000, early_stopping_rounds: 100  
  - 범주형 피처: `['Age', 'PrimaryKey']`  

---

## 4. 결론 및 향후 발전 방향

### 1) 실무 적용 가능성 평가

본 모델은 **현재 데이터 구조와 거의 동일한 환경**에서 즉시 운영에 투입할 수 있도록 설계되었다.

1. **기존 인지검사 시스템과의 연계**
   - 운수종사자가 A/B형 인지검사를 완료하면,  
     해당 로그를 전처리 파이프라인(`1_Preprocess_delta_logratio.py`)에 투입하여 자동으로 피처를 생성할 수 있다.
   - 이미 구축된 정규화 통계(`normalization_stats.pkl`)와 PK 통계(`pk_stats_final.csv`)를 활용하면  
     **추가 학습 없이도 동일 스케일**에서 위험도 산출이 가능하다.
   - 결과적으로 “검사 완료 → 수 분 내 위험도 산출”이 가능한 구조로,  
     기존 자격·적성검사 프로세스에 부담 없이 붙일 수 있다.

2. **위험도 등급화 및 관리 정책 연계**
   - 보정된 확률값은 그대로 **사고 발생 확률 추정치**로 활용 가능하며,  
     예를 들어 다음과 같이 등급을 정의할 수 있다.
     - 상위 5%: **고위험군(Red)** – 추가 정밀검사, 교육 의무화, 근무 패턴 점검
     - 상위 5~20%: **주의군(Amber)** – 집중 모니터링, 단기 교육 프로그램 권고
     - 나머지: **일반군(Green)** – 정기검사 주기 유지
   - 이러한 구간은 기관이 보유한 과거 사고 통계를 기반으로  
     **사고 발생률·정책 비용을 함께 고려하여 조정**할 수 있다.

3. **운수회사·지자체용 대시보드 구성**
   - 최종 산출물(위험도, 주요 인지지표, PK 이력)을 집계하면
     - 노선별·지점별 고위험 운수종사자 분포
     - 연령대·근무형태별 사고 위험 패턴
     - 교육 수료 전·후 위험도 변화  
     등을 모니터링하는 대시보드를 쉽게 구성할 수 있다.
   - 이는 **교통안전 정책 수립·예산 배분·교육 효과 측정**에 직접 활용 가능하다.

4. **운영상 모니터링 및 재학습 전략**
   - 새로 축적되는 검사/사고 데이터를 정기적으로 반영하여
     - 예: 연 1회 또는 반기 1회 재학습
   - 재학습 시에도
     - 동일 스크립트로 전처리·K-Fold 학습을 수행하고,
     - 기존 모델과 AUC/Brier/ECE를 비교해 **성능 저하 여부와 데이터 분포 변화(drift)** 를 점검할 수 있다.
   - 이와 같은 운영 프로세스를 문서화·자동화하면  
     **정책 환경·검사 도구 변경에도 안정적으로 적응**하는 모델로 운용 가능하다.

5. **현장 활용 시 기대 효과**
   - 정기검사에서 도출된 위험도 정보를 활용해
     - 사고 발생 전 **사전 개입(교육·휴식 권고·업무 재배치)** 이 가능해지고,
     - 고위험군을 선별적으로 관리함으로써  
       **전체 운행 집단의 사고율을 효율적으로 낮출 수 있는 기반**을 제공한다.
   - 동시에, 인지검사 결과와 실제 사고 간의 피드백 루프를 구축함으로써  
     **검사 도구·교육 프로그램을 주기적으로 개선**할 수 있다.

---

### 2) 향후 발전 방향

1. **설명 가능성(Explainability) 강화**
   - SHAP 값을 이용해 각 인지 영역이 위험도에 미치는 기여도를 산출하고,  
     운수종사자별 **개인 맞춤형 피드백 리포트** 생성 기능을 추가.

2. **추가 데이터 결합 및 모형 고도화**
   - 사고 이력, 운행 거리·시간, 근무 형태와의 결합을 통해  
     인지검사 기반 위험도와 실제 사고 발생 간의 관계를 정교하게 모델링.
   - 필요 시 시계열/생존모델(예: Cox, DeepSurv 등)로 확장하여  
     “다음 1년 내 사고 발생 확률”과 같은 시간 개념을 반영.

3. **교육·개입 시뮬레이션**
   - 특정 인지지표(예: Stroop 간섭, Flanker 정확도)가 개선되었을 때  
     예측 위험도가 얼마나 감소하는지 시뮬레이션함으로써  
     교육 프로그램 설계 및 정책 효과 평가에 직접 활용.

---

## 5. 참고자료 및 인용 모델 출처

### (1) 모델링 및 확률 보정 관련

- Yandex, **CatBoost Documentation** – CatBoost 알고리즘 및 파라미터 설명.  
- scikit-learn documentation – StratifiedKFold, IsotonicRegression, ROC AUC, Brier score 등 구현 참고.  
- Niculescu-Mizil, N., & Caruana, R. (2005). *Predicting Good Probabilities with Supervised Learning*. ICML.  
- Assel, M., et al. (2017). *The Brier score does not evaluate the clinical utility of diagnostic tests or prediction models*. Journal of Urology.  
- Šuster, S., et al. (2023). *Analysis of predictive performance and reliability of machine learning models*. Computer Methods and Programs in Biomedicine.  
- Kattan, M. W., et al. (2018). *The index of prediction accuracy: an intuitive measure useful for decision-analytic model evaluation*. Diagnostic and Prognostic Research.  

### (2) 인지심리학 / 운전 행동 연구

- Stroop, J. R. (1935). *Studies of Interference in Serial Verbal Reactions*. Journal of Experimental Psychology. – 스트룹 효과 원전.  
- Scarpina, F., & Tagini, S. (2017). *The Stroop Color and Word Test*. Frontiers in Psychology. – Stroop 과제를 이용한 실행 기능 평가 리뷰.  
- Eriksen, B. A., & Eriksen, C. W. (1974). *Effects of noise letters upon the identification of a target letter in a nonsearch task*. Perception & Psychophysics. – Flanker task 제안 논문.  
- Omran, Y. H., et al. (2023). *Driving Hazard Perception Tests: A Systematic Review*. Safety. – 운전 상황 Hazard Perception 테스트의 신뢰도·타당도 검토.  
- Prabhakharan, P., et al. (2024). *The efficacy of hazard perception training and education*. Accident Analysis & Prevention. – Hazard perception 훈련이 실제 사고 위험 감소에 미치는 효과 분석.  

---
